<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AML Analýza Klienta (ČAK Metodika)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font: Noto Sans + Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        h1, h2, h3, h4, .font-heading {
            font-family: 'Noto Sans', sans-serif;
        }

        /* Navigation Tabs */
        .nav-btn {
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .nav-btn.active {
            border-bottom-color: #0f172a; /* Slate 900 */
            color: #0f172a;
            font-weight: 600;
        }
        .nav-btn:hover:not(.active) {
            color: #64748b;
        }

        /* Form Elements */
        .form-checkbox:checked {
            background-color: #0f172a;
            border-color: #0f172a;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .risk-badge-high { @apply bg-red-100 text-red-800 border-red-200; }
        .risk-badge-medium { @apply bg-orange-100 text-orange-800 border-orange-200; }
        .risk-badge-low { @apply bg-green-100 text-green-800 border-green-200; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="switchTab('tab-analyza')">
                <div class="bg-slate-900 text-white w-8 h-8 rounded flex items-center justify-center font-bold">A</div>
                <div>
                    <h1 class="text-lg font-bold text-slate-900 font-heading">AML Analýza Klienta</h1>
                    <p class="text-slate-500 text-[10px] uppercase tracking-wider leading-none">Nástroj dle Metodiky ČAK</p>
                </div>
            </div>
            
            <!-- Desktop Nav -->
            <nav class="hidden md:flex gap-6">
                <button onclick="switchTab('tab-analyza')" id="btn-tab-analyza" class="nav-btn active py-5 text-sm">Analýza Klienta</button>
                <button onclick="switchTab('tab-rizika')" id="btn-tab-rizika" class="nav-btn py-5 text-sm">Typologie rizik (Reference)</button>
            </nav>

            <!-- Mobile Menu Button (Placeholder) -->
            <button class="md:hidden text-slate-600">
                <i data-lucide="menu"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">

        <!-- TAB 1: ANALÝZA KLIENTA (Main Tool) -->
        <section id="tab-analyza" class="animate-fade">
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
                
                <!-- INPUT COLUMN -->
                <div class="xl:col-span-4 space-y-6">
                    
                    <!-- 1. Sledovaná činnost -->
                    <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-2 mb-4 border-b pb-2">
                            <span class="bg-slate-100 p-1.5 rounded text-slate-600"><i data-lucide="briefcase" size="18"></i></span>
                            <h3 class="font-bold text-slate-800">1. Typ právní služby</h3>
                        </div>
                        
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-slate-700">O jakou činnost se jedná?</label>
                            <select id="serviceType" onchange="toggleFormState()" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-slate-900 focus:border-slate-900 transition">
                                <option value="" disabled selected>Vyberte ze seznamu...</option>
                                <optgroup label="Sledované činnosti (§ 2 AMLZ)">
                                    <option value="uschova">Advokátní úschova (peníze/cenné papíry)</option>
                                    <option value="nemovitost">Koupě/prodej nemovitosti nebo podniku</option>
                                    <option value="korporace_start">Zakládání/řízení obchodní korporace</option>
                                    <option value="majatek">Správa majetku/svěřenského fondu</option>
                                    <option value="finance">Inkasa, platby, převody</option>
                                </optgroup>
                                <optgroup label="Ostatní (Výjimky/Mlčenlivost)">
                                    <option value="obhajoba">Obhajoba v trestním řízení</option>
                                    <option value="poradenstvi">Právní poradenství / Spory</option>
                                </optgroup>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Sledované činnosti jsou definovány v § 2 odst. 1 písm. g) AMLZ.</p>
                        </div>
                    </div>

                    <!-- 2. Parametry obchodu -->
                    <div id="paramGroup" class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm transition-opacity duration-300">
                        <div class="flex items-center gap-2 mb-4 border-b pb-2">
                            <span class="bg-slate-100 p-1.5 rounded text-slate-600"><i data-lucide="banknote" size="18"></i></span>
                            <h3 class="font-bold text-slate-800">2. Parametry obchodu</h3>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Hodnota obchodu / transakce</label>
                                <div class="relative">
                                    <input type="number" id="tradeValue" class="w-full p-2.5 pl-4 border border-slate-300 rounded text-sm" placeholder="0">
                                    <span class="absolute right-8 top-2.5 text-slate-400 text-sm">EUR</span>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="setVal(1000)" class="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">1 000 €</button>
                                    <button onclick="setVal(15000)" class="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">15 000 €</button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="isBusinessRel" class="rounded text-slate-900 focus:ring-slate-900 border-gray-300">
                                    <span class="text-sm text-slate-700">Jedná se o <strong>obchodní vztah</strong>?</span>
                                </label>
                                <p class="text-xs text-slate-500 ml-6">Opakující se plnění nebo trvalý smluvní vztah.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Rizikový profil -->
                    <div id="riskGroup" class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm transition-opacity duration-300">
                        <div class="flex items-center gap-2 mb-4 border-b pb-2">
                            <span class="bg-slate-100 p-1.5 rounded text-slate-600"><i data-lucide="alert-triangle" size="18"></i></span>
                            <h3 class="font-bold text-slate-800">3. Rizikové faktory</h3>
                        </div>

                        <div class="space-y-3">
                            <!-- Klient -->
                            <div class="border rounded p-3 bg-slate-50">
                                <span class="text-xs font-bold text-slate-500 uppercase">Klient</span>
                                <label class="flex items-start gap-2 mt-2 cursor-pointer">
                                    <input type="checkbox" id="isPEP" class="mt-1 rounded text-slate-900 border-gray-300">
                                    <span class="text-sm text-slate-800">Politicky exponovaná osoba (PEP)</span>
                                </label>
                                <label class="flex items-start gap-2 mt-2 cursor-pointer">
                                    <input type="checkbox" id="isSanctioned" class="mt-1 rounded text-slate-900 border-gray-300">
                                    <span class="text-sm text-slate-800">Sankcionovaná osoba (Mez. sankce)</span>
                                </label>
                                 <label class="flex items-start gap-2 mt-2 cursor-pointer">
                                    <input type="checkbox" id="isNonFace" class="mt-1 rounded text-slate-900 border-gray-300">
                                    <span class="text-sm text-slate-800">Identifikace bez fyzické přítomnosti</span>
                                </label>
                            </div>

                            <!-- Původ / Země -->
                            <div class="border rounded p-3 bg-slate-50">
                                <span class="text-xs font-bold text-slate-500 uppercase">Původ & Transakce</span>
                                <label class="flex items-start gap-2 mt-2 cursor-pointer">
                                    <input type="checkbox" id="isHighRiskCountry" class="mt-1 rounded text-slate-900 border-gray-300">
                                    <span class="text-sm text-slate-800">Vazba na vysoce rizikovou 3. zemi</span>
                                </label>
                                <label class="flex items-start gap-2 mt-2 cursor-pointer">
                                    <input type="checkbox" id="isCash" class="mt-1 rounded text-slate-900 border-gray-300">
                                    <span class="text-sm text-slate-800">Platba v hotovosti</span>
                                </label>
                                <label class="flex items-start gap-2 mt-2 cursor-pointer">
                                    <input type="checkbox" id="isComplex" class="mt-1 rounded text-slate-900 border-gray-300">
                                    <span class="text-sm text-slate-800">Neobvykle složitá struktura</span>
                                </label>
                            </div>

                             <!-- Podezření -->
                             <div class="border border-red-200 rounded p-3 bg-red-50">
                                <label class="flex items-start gap-2 cursor-pointer">
                                    <input type="checkbox" id="isSuspicious" class="mt-1 rounded text-red-600 focus:ring-red-600 border-red-300">
                                    <div>
                                        <span class="text-sm font-bold text-red-900">Podezřelý obchod (OPO)</span>
                                        <p class="text-xs text-red-700">Nejasný původ, nervozita, spěch, neochota...</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <button onclick="analyze()" class="w-full mt-6 bg-slate-900 text-white font-bold py-3 px-4 rounded shadow hover:bg-slate-800 transition flex justify-center gap-2 items-center">
                            Vyhodnotit povinnosti
                        </button>
                    </div>

                </div>

                <!-- OUTPUT COLUMN -->
                <div class="xl:col-span-8">
                    <!-- Default State -->
                    <div id="outputDefault" class="h-full flex flex-col items-center justify-center text-slate-400 min-h-[400px] border-2 border-dashed border-slate-200 rounded-lg">
                        <i data-lucide="clipboard-list" size="48" class="mb-4 text-slate-300"></i>
                        <p>Zadejte parametry v levém sloupci pro zobrazení analýzy.</p>
                    </div>

                    <!-- Result State -->
                    <div id="outputResult" class="hidden space-y-6">
                        
                        <!-- Top Status Banner -->
                        <div id="statusBanner" class="p-5 rounded-lg border-l-4 shadow-sm bg-white flex items-start gap-4">
                            <!-- Injected JS -->
                        </div>

                        <!-- Action Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <!-- 1. IDENTIFIKACE -->
                            <div class="bg-white rounded-lg border border-slate-200 shadow-sm flex flex-col">
                                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-lg">
                                    <h4 class="font-bold text-slate-700 flex items-center gap-2">
                                        <i data-lucide="user-check" size="18"></i> Identifikace klienta
                                    </h4>
                                    <span id="badgeId" class="text-xs font-bold px-2 py-1 rounded bg-slate-200 text-slate-600">---</span>
                                </div>
                                <div class="p-5 flex-grow">
                                    <p id="textId" class="text-sm text-slate-600 mb-4"></p>
                                    <div id="checklistId" class="bg-blue-50 p-4 rounded text-sm text-blue-900 space-y-2 hidden">
                                        <p class="font-bold text-xs uppercase text-blue-500 mb-2">Požadované dokumenty / Úkony:</p>
                                        <ul class="list-disc list-inside space-y-1 pl-1">
                                            <!-- Items -->
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. KONTROLA -->
                            <div class="bg-white rounded-lg border border-slate-200 shadow-sm flex flex-col">
                                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-lg">
                                    <h4 class="font-bold text-slate-700 flex items-center gap-2">
                                        <i data-lucide="search" size="18"></i> Kontrola klienta
                                    </h4>
                                    <span id="badgeCtrl" class="text-xs font-bold px-2 py-1 rounded bg-slate-200 text-slate-600">---</span>
                                </div>
                                <div class="p-5 flex-grow">
                                    <p id="textCtrl" class="text-sm text-slate-600 mb-4"></p>
                                    <div id="checklistCtrl" class="bg-orange-50 p-4 rounded text-sm text-orange-900 space-y-2 hidden">
                                        <p class="font-bold text-xs uppercase text-orange-500 mb-2">Rozsah kontroly:</p>
                                        <ul class="list-disc list-inside space-y-1 pl-1">
                                            <!-- Items -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Special Alerts -->
                        <div id="alertBox" class="hidden">
                             <!-- Injected JS -->
                        </div>

                        <!-- Risk Assessment Section -->
                        <div class="bg-slate-50 p-5 rounded-lg border border-slate-200">
                             <h4 class="font-bold text-slate-800 mb-3 text-sm uppercase">Předběžné hodnocení rizik (dle Metodiky)</h4>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div id="riskGeo" class="p-3 bg-white rounded border border-slate-200">
                                    <span class="block text-xs text-slate-500">Geografické riziko</span>
                                    <span class="font-medium">Nízké / Běžné</span>
                                </div>
                                <div id="riskClient" class="p-3 bg-white rounded border border-slate-200">
                                    <span class="block text-xs text-slate-500">Riziko klienta</span>
                                    <span class="font-medium">Nízké / Běžné</span>
                                </div>
                                <div id="riskService" class="p-3 bg-white rounded border border-slate-200">
                                    <span class="block text-xs text-slate-500">Riziko služby</span>
                                    <span class="font-medium">Nízké / Běžné</span>
                                </div>
                             </div>
                        </div>

                    </div>
                </div>
            </div>
        </section>

        <!-- TAB 2: RIZIKOVÉ FAKTORY (Reference) -->
        <section id="tab-rizika" class="hidden animate-fade">
             <div class="max-w-4xl mx-auto space-y-8">
                <div class="border-b pb-4">
                    <h2 class="text-2xl font-bold text-slate-900">Typologie rizik dle Metodiky ČAK</h2>
                    <p class="text-slate-500 mt-2">Níže uvedené faktory slouží jako indikátory pro nastavení rizikového profilu klienta ve formuláři.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg border border-slate-200">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600"><i data-lucide="map" size="16"></i></span>
                            <h3 class="font-bold text-slate-800">Geografická rizika</h3>
                        </div>
                        <ul class="space-y-2 text-sm text-slate-600 list-disc list-inside">
                            <li>Země podporující financování terorismu (např. Írán, KLDR, Sýrie).</li>
                            <li>Země s vysokým podílem korupce.</li>
                            <li>Země sankcionované EU/OSN (Rusko, Bělorusko).</li>
                            <li>Země bez účinného AML systému.</li>
                            <li>Daňové ráje (offshore destinace).</li>
                        </ul>
                    </div>

                    <div class="bg-white p-6 rounded-lg border border-slate-200">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600"><i data-lucide="user" size="16"></i></span>
                            <h3 class="font-bold text-slate-800">Rizika na straně klienta</h3>
                        </div>
                        <ul class="space-y-2 text-sm text-slate-600 list-disc list-inside">
                            <li>Neprůhledná nebo složitá vlastnická struktura.</li>
                            <li>Politicky exponovaná osoba (PEP).</li>
                            <li>Klient vyžaduje anonymitu.</li>
                            <li>Klient podniká v rizikovém oboru (hotovost, drahé kovy).</li>
                            <li>Odmítání poskytnutí dokladů ke kontrole.</li>
                        </ul>
                    </div>

                    <div class="bg-white p-6 rounded-lg border border-slate-200">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600"><i data-lucide="briefcase" size="16"></i></span>
                            <h3 class="font-bold text-slate-800">Rizika služby/transakce</h3>
                        </div>
                        <ul class="space-y-2 text-sm text-slate-600 list-disc list-inside">
                            <li>Platby od třetích neznámých osob.</li>
                            <li>Neobvyklé transakce bez ekonomického důvodu.</li>
                            <li>Vysoké objemy hotovosti.</li>
                            <li>Nákup nemovitosti za výrazně odlišnou cenu než tržní.</li>
                            <li>Založení "shell company" bez zjevného účelu.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 py-6 mt-auto">
        <div class="container mx-auto px-4 text-center text-slate-400 text-xs">
            <p class="font-bold text-slate-600 mb-1">Nástroj pro podporu advokátní praxe</p>
            <p>Aplikace zpracovává postupy dle Metodické informace ČAK (AML).</p>
            <p class="mt-2">Výstupy slouží pro interní potřebu advokátní kanceláře.</p>
        </div>
    </footer>

    <!-- Logic -->
    <script>
        // Init Lucide icons
        lucide.createIcons();

        function switchTab(tabId) {
            // Hide all sections
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            
            // Show target
            const target = document.getElementById(tabId);
            target.classList.remove('hidden');
            target.classList.remove('animate-fade');
            void target.offsetWidth; 
            target.classList.add('animate-fade');

            // Update nav
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById('btn-' + tabId);
            if(btn) btn.classList.add('active');

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function setVal(val) {
            document.getElementById('tradeValue').value = val;
        }

        function toggleFormState() {
            const service = document.getElementById('serviceType').value;
            const paramGroup = document.getElementById('paramGroup');
            const riskGroup = document.getElementById('riskGroup');
            
            // Logic: Is this an exempt service?
            const isExempt = ['obhajoba', 'poradenstvi'].includes(service);

            if (isExempt) {
                // Dim non-relevant sections but keep them visible to avoid layout jump
                paramGroup.classList.add('opacity-50', 'pointer-events-none');
                riskGroup.classList.add('opacity-50', 'pointer-events-none');
                // Auto-analyze to show exemption message
                analyze();
            } else {
                paramGroup.classList.remove('opacity-50', 'pointer-events-none');
                riskGroup.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        function analyze() {
            // 1. Gather Inputs
            const service = document.getElementById('serviceType').value;
            if (!service) return; // Do nothing if no service selected

            const value = parseFloat(document.getElementById('tradeValue').value) || 0;
            const isBusinessRel = document.getElementById('isBusinessRel').checked;
            
            // Risks
            const isPEP = document.getElementById('isPEP').checked;
            const isSanctioned = document.getElementById('isSanctioned').checked;
            const isNonFace = document.getElementById('isNonFace').checked;
            const isHighRiskCountry = document.getElementById('isHighRiskCountry').checked;
            const isSuspicious = document.getElementById('isSuspicious').checked;
            const isCash = document.getElementById('isCash').checked;
            const isComplex = document.getElementById('isComplex').checked;

            // 2. Prepare Output Elements
            const outputDefault = document.getElementById('outputDefault');
            const outputResult = document.getElementById('outputResult');
            
            const statusBanner = document.getElementById('statusBanner');
            const alertBox = document.getElementById('alertBox');
            
            const badgeId = document.getElementById('badgeId');
            const textId = document.getElementById('textId');
            const checklistId = document.getElementById('checklistId');
            
            const badgeCtrl = document.getElementById('badgeCtrl');
            const textCtrl = document.getElementById('textCtrl');
            const checklistCtrl = document.getElementById('checklistCtrl');

            outputDefault.classList.add('hidden');
            outputResult.classList.remove('hidden');
            alertBox.classList.add('hidden');
            alertBox.innerHTML = '';

            // 3. Logic Engine

            // A. Is it an Exempt Service?
            if (['obhajoba', 'poradenstvi'].includes(service)) {
                setStatus('safe', 'Výjimka z AML', 'Na tuto službu se AML povinnosti nevztahují (povinnost mlčenlivosti).');
                
                // ID
                badgeId.innerText = "ZÁKLADNÍ";
                badgeId.className = "text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-800";
                textId.innerText = "Identifikace pouze v rozsahu nutném pro poskytnutí právní služby (klient ve spisu).";
                checklistId.classList.add('hidden');

                // CTRL
                badgeCtrl.innerText = "NEPROVÁDÍ SE";
                badgeCtrl.className = "text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-800";
                textCtrl.innerText = "Kontrola klienta ani zjišťování původu majetku se neprovádí.";
                checklistCtrl.classList.add('hidden');

                // Risk badging
                setRiskLevels('Nízké', 'Nízké', 'Nízké');
                
                return; // Stop execution
            }

            // B. Sanctions Check (Immediate Stop)
            if (isSanctioned) {
                setStatus('danger', 'SANKCIONOVANÁ OSOBA', 'Klient je na sankčním seznamu. Povinnost podat OPO a majetek zajistit (zmrazit).');
                addAlert('danger', 'Zákaz provedení obchodu! Nutno kontaktovat FAÚ/ČAK a podat Oznámení podezřelého obchodu.');
                
                badgeId.innerText = "KRITICKÉ";
                badgeCtrl.innerText = "KRITICKÉ";
                textId.innerText = "Okamžité nahlášení.";
                textCtrl.innerText = "Okamžité nahlášení.";
                checklistId.classList.add('hidden');
                checklistCtrl.classList.add('hidden');
                return;
            }

            // C. Suspicious Transaction (OPO)
            if (isSuspicious) {
                setStatus('danger', 'PODEZŘELÝ OBCHOD (OPO)', 'Byli naplněny znaky podezřelosti. Nutno zvážit podání OPO.');
                addAlert('warning', '<strong>Zákaz tipping-off:</strong> Klientovi nesmíte sdělit, že podáváte hlášení.');
            }

            // D. Identification Logic
            let reqId = false;
            let idType = "Standardní";
            let idReason = "";

            if (service === 'uschova') {
                reqId = true;
                idReason = "Úschova: Identifikace vždy bez ohledu na limit.";
            } else if (isBusinessRel) {
                reqId = true;
                idReason = "Obchodní vztah: Identifikace vždy při vzniku vztahu.";
            } else if (value >= 1000) {
                reqId = true;
                idReason = "Limit > 1 000 EUR.";
            } else if (isSuspicious) {
                reqId = true;
                idReason = "Podezřelý obchod: Identifikace vždy.";
            }

            // ID Render
            if (reqId) {
                badgeId.innerText = "NUTNÁ";
                badgeId.className = "text-xs font-bold px-2 py-1 rounded bg-blue-100 text-blue-800";
                textId.innerText = idReason;
                checklistId.classList.remove('hidden');
                
                let items = [];
                items.push("Zaznamenat identifikační údaje (Jméno, nar., trvalý pobyt, občanství).");
                if (isNonFace) {
                    items.push("<strong>Na dálku:</strong> Kopie 2 dokladů + První platba z účtu klienta (nebo BankID).");
                } else {
                    items.push("<strong>Face-to-face:</strong> Kontrola průkazu totožnosti + ověření podoby.");
                }
                items.push("Záznam o tom, zda je klient PEP.");
                items.push("Ověření sankčních seznamů.");
                
                renderChecklist('checklistId', items);
            } else {
                badgeId.innerText = "NENÍ NUTNÁ";
                badgeId.className = "text-xs font-bold px-2 py-1 rounded bg-slate-200 text-slate-600";
                textId.innerText = "Podlimitní obchod (< 1000 EUR) mimo obchodní vztah.";
                checklistId.classList.add('hidden');
            }


            // E. Control Logic
            let reqCtrl = false;
            let ctrlLevel = "Standard"; // Standard, Enhanced
            let ctrlReason = "";

            // Triggers for control
            if (service === 'uschova' || isBusinessRel) { 
                reqCtrl = true; // Metodika implies control for business relations or risky services like custody usually implies higher scrutiny
                ctrlReason = "Obchodní vztah / Úschova.";
            }
            if (value >= 15000) {
                reqCtrl = true;
                ctrlReason = "Limit > 15 000 EUR.";
            }
            if (isPEP || isHighRiskCountry || isComplex || isSuspicious) {
                reqCtrl = true;
                ctrlLevel = "Enhanced";
                ctrlReason = "Rizikové faktory (PEP, Země, Podezření).";
            }

            // Control Render
            if (reqCtrl) {
                const isEnhanced = ctrlLevel === "Enhanced";
                badgeCtrl.innerText = isEnhanced ? "ZESÍLENÁ (EDD)" : "STANDARD";
                badgeCtrl.className = isEnhanced 
                    ? "text-xs font-bold px-2 py-1 rounded bg-orange-100 text-orange-800 border border-orange-200" 
                    : "text-xs font-bold px-2 py-1 rounded bg-blue-100 text-blue-800";
                
                textCtrl.innerHTML = ctrlReason;
                checklistCtrl.classList.remove('hidden');

                let items = [];
                items.push("Zjištění vlastnické struktury a Skutečného majitele (UBO).");
                items.push("Zjištění účelu a povahy obchodu.");
                items.push("Výpis z Evidence skutečných majitelů.");
                
                if (isEnhanced) {
                    items.push("<strong>Původ majetku:</strong> Doložení zdroje prostředků (výpisy, smlouvy).");
                    if (isPEP) items.push("<strong>PEP:</strong> Souhlas statutárního orgánu advokáta/kanceláře.");
                    items.push("Průběžné sledování obchodního vztahu.");
                }
                
                renderChecklist('checklistCtrl', items);

                // Update Status Banner if not already suspicious
                if (!isSuspicious) {
                    if (isEnhanced) {
                        setStatus('warning', 'Vysoké Riziko', 'Nutná zesílená kontrola (EDD). Obchod vyžaduje doložení původu majetku.');
                    } else {
                        setStatus('info', 'Standardní postup', 'Nutná identifikace a standardní kontrola klienta.');
                    }
                }

            } else {
                badgeCtrl.innerText = "NENÍ NUTNÁ";
                badgeCtrl.className = "text-xs font-bold px-2 py-1 rounded bg-slate-200 text-slate-600";
                textCtrl.innerText = "Podlimitní obchod bez rizikových faktorů.";
                checklistCtrl.classList.add('hidden');
                
                if (!isSuspicious && reqId) {
                    setStatus('info', 'Pouze Identifikace', 'Obchod vyžaduje identifikaci, ale nesplňuje limity pro kontrolu.');
                } else if (!isSuspicious) {
                    setStatus('safe', 'Podlimitní obchod', 'Nejsou vyžadována AML opatření.');
                }
            }

            // F. Risk Visualization
            let rGeo = isHighRiskCountry ? "Vysoké" : "Nízké";
            let rClient = (isPEP || isSanctioned || isComplex) ? "Vysoké" : "Běžné";
            let rService = (service === 'uschova' || isCash) ? "Vysoké" : "Běžné";

            setRiskLevels(rGeo, rClient, rService);
        }

        // --- Helper Functions ---

        function renderChecklist(elementId, items) {
            const list = document.querySelector(`#${elementId} ul`);
            list.innerHTML = items.map(i => `<li>${i}</li>`).join('');
        }

        function setStatus(type, title, desc) {
            const banner = document.getElementById('statusBanner');
            let icon, colorClass;

            if (type === 'danger') {
                icon = '<i data-lucide="alert-octagon" class="text-red-600" size="32"></i>';
                colorClass = 'border-red-500 bg-red-50';
            } else if (type === 'warning') {
                icon = '<i data-lucide="alert-triangle" class="text-orange-600" size="32"></i>';
                colorClass = 'border-orange-500 bg-orange-50';
            } else if (type === 'safe') {
                icon = '<i data-lucide="check-circle" class="text-green-600" size="32"></i>';
                colorClass = 'border-green-500 bg-green-50';
            } else {
                icon = '<i data-lucide="info" class="text-blue-600" size="32"></i>';
                colorClass = 'border-blue-500 bg-blue-50';
            }

            banner.className = `p-5 rounded-lg border-l-4 shadow-sm flex items-start gap-4 ${colorClass}`;
            banner.innerHTML = `
                <div>${icon}</div>
                <div>
                    <h3 class="font-bold text-lg text-slate-800">${title}</h3>
                    <p class="text-sm text-slate-600 mt-1">${desc}</p>
                </div>
            `;
            lucide.createIcons();
        }

        function addAlert(type, htmlContent) {
            const box = document.getElementById('alertBox');
            box.classList.remove('hidden');
            const colorClass = type === 'danger' ? 'bg-red-100 border-red-200 text-red-900' : 'bg-orange-100 border-orange-200 text-orange-900';
            
            box.innerHTML = `
                <div class="p-4 rounded border ${colorClass} text-sm flex gap-3">
                    <i data-lucide="alert-circle" size="20" class="shrink-0"></i>
                    <div>${htmlContent}</div>
                </div>
            `;
            lucide.createIcons();
        }

        function setRiskLevels(geo, client, service) {
            const getBadge = (val) => {
                const color = val === 'Vysoké' ? 'risk-badge-high' : (val === 'Běžné' ? 'risk-badge-medium' : 'risk-badge-low');
                return `<span class="inline-block px-2 py-0.5 rounded text-xs font-bold border ${color}">${val}</span>`;
            };

            document.getElementById('riskGeo').querySelector('span.font-medium').innerHTML = getBadge(geo);
            document.getElementById('riskClient').querySelector('span.font-medium').innerHTML = getBadge(client);
            document.getElementById('riskService').querySelector('span.font-medium').innerHTML = getBadge(service);
        }

    </script>
</body>
</html>
